---
# tasks file for ocp4 cluster nodes configuration

# Wait at least 30m for node connection
- name: Check connection
  wait_for_connection:
    delay: 15
    connect_timeout: 15
    timeout: "{{ node_connection_timeout }}"

 # reboot:
 #   reboot_timeout: 600
 #   reboot_command: sudo reboot
#    sudo reboot
#  shell: coreos.inst.root=/dev/disk/by-label/dm-mpath-root
#  shell: coreos.inst.install_dev=/dev/sda
  

- name: Configure node
  shell: |
    if lsmod|grep -q 'ibmveth'; then
      sudo sysctl -w net.ipv4.route.min_pmtu=1450;
      sudo sysctl -w net.ipv4.ip_no_pmtu_disc=1;
      echo 'net.ipv4.route.min_pmtu = 1450' | sudo tee --append /etc/sysctl.d/88-sysctl.conf > /dev/null;
      echo 'net.ipv4.ip_no_pmtu_disc = 1' | sudo tee --append /etc/sysctl.d/88-sysctl.conf > /dev/null;
    fi

- name: kernel configuration
  shell: | 
    sudo rpm-ostree kargs --append=rd.multipath=default
    sudo rpm-ostree kargs --append=root=/dev/disk/by-label/dm-mpath-root
    sudo rpm-ostree kargs --append=rw
 #   sudo reboot

- name: reboot                                                              
    at: 
      - command=sudo reboot 
      - count=1 
      - units=minutes                                  

- name: wait for sshd on vms to resume                                      
  wait_for:                                                                 
    host: {{ inventory_hostname }}                                                    
    port: 22                                                                
    delay: 90  
